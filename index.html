<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arens Computer System</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.terminal@2.35.2/css/jquery.terminal.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal@2.35.2/js/jquery.terminal.min.js"></script>
    <style>
        body {
            background-color: #0a0e17;
            color: #64b5f6;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 15px;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        #background-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            display: flex;
            pointer-events: none;
        }
        #background-left, #background-right {
            flex: 1;
            overflow: hidden;
            opacity: 0.3;
            font-size: 0.8em;
            padding: 20px;
        }
        #background-left {
            text-align: left;
        }
        #background-right {
            text-align: right;
        }
        #background-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.1;
        }
        #terminal-container {
            position: relative;
            z-index: 10;
            max-width: 900px;
            margin: 0 auto;
            border: 2px solid #5c6bc0;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(92, 107, 192, 0.4);
            height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
        }
        #terminal {
            flex: 1;
            overflow: auto !important;
            min-height: 0;
            background-color: rgba(10, 14, 23, 0.85);
            padding: 10px;
        }
        .terminal {
            background-color: #0a0e17 !important;
            color: #64b5f6 !important;
            font-family: 'Courier New', monospace !important;
            height: 100% !important;
            overflow: auto !important;
        }
        .terminal-output {
            line-height: 1.4 !important;
            word-wrap: break-word !important;
        }
        .prompt {
            color: #5c6bc0 !important;
            font-weight: bold !important;
        }
        .status-bar {
            background-color: #1a237e;
            padding: 5px 10px;
            border-top: 1px solid #5c6bc0;
            font-size: 0.9em;
            color: #bbdefb;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
        }
        .blink {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        #terminal::-webkit-scrollbar {
            width: 8px;
        }
        #terminal::-webkit-scrollbar-track {
            background: #1a237e;
        }
        #terminal::-webkit-scrollbar-thumb {
            background: #5c6bc0;
            border-radius: 4px;
        }
        #terminal::-webkit-scrollbar-thumb:hover {
            background: #3949ab;
        }
        .log-entry {
            font-size: 0.8em;
            color: #9fa8da;
            margin: 2px 0;
        }
        .matrix-char {
            position: absolute;
            color: rgba(92, 107, 192, 0.1);
            font-size: 18px;
            font-family: 'Courier New', monospace;
        }
        /* Lancer Comp/Con theme styles */
        body.theme-compcon {
            color: #64b5f6;
        }
        body.theme-compcon .terminal, body.theme-compcon #terminal {
            background-color: rgba(10, 14, 23, 0.85) !important;
        }
        body.theme-compcon .status-bar, body.theme-compcon #terminal-container {
            border-color: #5c6bc0;
            box-shadow: 0 0 15px rgba(92, 107, 192, 0.4);
        }
        body.theme-compcon #terminal::-webkit-scrollbar-thumb {
            background: #5c6bc0;
        }
        body.theme-crimson {
            color: #f44336;
        }
        body.theme-crimson .terminal, body.theme-crimson #terminal {
            background-color: rgba(25, 10, 10, 0.85) !important;
        }
        body.theme-crimson .status-bar, body.theme-crimson #terminal-container {
            border-color: #f44336;
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.4);
        }
        body.theme-crimson #terminal::-webkit-scrollbar-thumb {
            background: #f44336;
        }
        body.theme-emerald {
            color: #4caf50;
        }
        body.theme-emerald .terminal, body.theme-emerald #terminal {
            background-color: rgba(10, 25, 15, 0.85) !important;
        }
        body.theme-emerald .status-bar, body.theme-emerald #terminal-container {
            border-color: #4caf50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
        }
        body.theme-emerald #terminal::-webkit-scrollbar-thumb {
            background: #4caf50;
        }
        .background-log {
            position: absolute;
            color: rgba(92, 107, 192, 0.3);
            font-family: 'Courier New', monospace;
            white-space: nowrap;
            animation: scroll-log 30s linear infinite;
        }
        @keyframes scroll-log {
            from { transform: translateY(100%); }
            to { transform: translateY(-100%); }
        }
    </style>
</head>
<body class="theme-compcon">
    <div id="background-container">
        <div id="background-left"></div>
        <div id="background-right"></div>
    </div>
    <canvas id="background-canvas"></canvas>
    <div id="terminal-container">
        <div id="terminal"></div>
        <div class="status-bar">
            <span>Arens v2.0.8 | Status: <span class="blink">ONLINE</span></span>
            <span id="system-time">00:00:00</span>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // System state
            const systemState = {
                poweredOn: true,
                shipName: 'Das Krokodil',
                hullIntegrity: 100,
                coreIntegrity: 100,
                fuel: 99,
                oxygen: 100,
                mode: 'Park',
                speed: 0,
                baseFuelConsumption: 0.1,
                lastSpeedUpdate: Date.now(),
                crew: [
                    {name: "Captain Elara Vance", role: "Command", status: "Active"},
                    {name: "Dr. Kaelen Rostov", role: "Medical Officer", status: "Active"},
                    {name: "Chief Engineer Tarek", role: "Engineering", status: "Active"},
                    {name: "Lt. Mira Chen", role: "Navigation", status: "Active"},
                    {name: "Security Officer Jax", role: "Security", status: "Active"}
                ],
                missionLogs: [
                    "MISSION LOG #45892: Successfully negotiated trade agreement with Vega Colony",
                    "MISSION LOG #45893: Encountered hostile vessel in Sector 7-G. Weapons systems engaged. Threat neutralized.",
                    "MISSION LOG #45894: Discovered ancient artifact on planet surface. Scientific analysis ongoing.",
                    "MISSION LOG #45895: Resupplied at Kepler Station. Restocked medical supplies and weapons."
                ],
                systemAlerts: [
                    "ALERT: Minor hull breach detected in sector 4-C. Sealed automatically.",
                    "WARNING: Unidentified vessel approaching from bearing 225 mark 17.",
                    "NOTICE: Life support systems at 98% efficiency. Maintenance recommended.",
                    "SECURITY: Intrusion attempt detected on comms channel. Source traced and blocked."
                ],
                diagnostics: {
                    cpu: "98% operational",
                    memory: "4.2MB free / 16MB total",
                    powerDistribution: "Nominal",
                    networkLatency: "12ms",
                    securityLevel: "Gamma-7"
                },
                theme: 'compcon' // Default Lancer CompCon theme
            };

            // Background logs data
            const backgroundLogs = [
                "[SYSTEM] Memory check complete: 4.2MB free",
                "[NAVIGATION] Course plotted to Kepler Station",
                "[SENSORS] No hostile contacts detected",
                "[COMMS] Standing by for incoming transmissions",
                "[ENGINEERING] Power distribution nominal",
                "[SECURITY] All systems secure",
                "[LIFE SUPPORT] Oxygen levels stable at 100%",
                "[FUEL] Current reserves: 99%",
                "[CREW] Captain Elara Vance on duty",
                "[WEAPONS] All systems offline - Park mode",
                "[SHIELDS] Offline - Park mode",
                "[SENSORS] Long range scan active",
                "[NAVIGATION] ETA to nearest station: 3 days",
                "[COMMS] Frequency locked to military band",
                "[SECURITY] Access logs verified",
                "[ENGINEERING] Core temperature normal",
                "[MEDICAL] Sick bay ready for emergencies",
                "[CARGO] Manifest verified - all items secure",
                "[SENSORS] Meteor shower detected at 200,000km range",
                "[NAVIGATION] Gravitational anomalies mapped",
                "[COMMS] Encryption protocols active",
                "[SECURITY] Intrusion detection system online",
                "[ENGINEERING] Backup systems operational",
                "[LIFE SUPPORT] CO2 scrubbers functioning at 98%",
                "[FUEL] Consumption rate: 0.1%/ly at current speed"
            ];

            // Calculate fuel consumption based on speed (exponential increase)
            function calculateFuelConsumption(speed) {
                // Base consumption plus exponential increase with speed
                return systemState.baseFuelConsumption * (1 + Math.pow(speed / 50000, 2));
            }

            // Menu navigation stack
            const menuStack = ['main'];

            // Command mappings for alternative text inputs
            const commandMappings = {
                'main': {
                    'ship modi': '1', 'modi': '1', 'ship': '1', 'mode': '1',
                    'ship info': '2', 'info': '2', 'status': '2',
                    'omniweb': '3', 'web': '3', 'internet': '3',
                    'settings': '4', 'setting': '4',
                    'on/off/restart': '5', 'power': '5', 'restart': '5'
                },
                'onoffrestart': {
                    'on': '1', 'power on': '1',
                    'off': '2', 'power off': '2',
                    'restart': '3', 'reboot': '3',
                    'back': '4'
                },
                'shipmodi': {
                    'park': '1',
                    'fly': '2', 'flight': '2',
                    'combat': '3', 'battle': '3',
                    'emergency': '4', 'emergency mode': '4',
                    'back': '5'
                },
                'shipmodi_fly': {
                    'speed increase': '1', 'increase': '1', 'faster': '1', 'accelerate': '1',
                    'speed decrease': '2', 'decrease': '2', 'slower': '2', 'decelerate': '2',
                    'manual steering': '3', 'manual': '3',
                    'automatic steering': '4', 'auto': '4', 'automatic': '4',
                    'back': '5'
                },
                'omniweb': {
                    'galactic news': '1', 'news': '1',
                    'system maps': '2', 'maps': '2',
                    'contact directory': '3', 'contacts': '3', 'directory': '3',
                    'mission logs': '4', 'logs': '4', 'missions': '4',
                    'back': '5'
                },
                'settings': {
                    'display settings': '1', 'display': '1', 'theme': '1',
                    'audio settings': '2', 'audio': '2', 'sound': '2',
                    'security settings': '3', 'security': '3',
                    'diagnostics': '4', 'system diagnostics': '4',
                    'back': '5'
                },
                'shipinfo': {
                    'refuel': '1', 'fuel': '1', 'refuel ship': '1',
                    'back': '2'
                }
            };

            // Function to display menu based on current path
            function displayMenu(menuPath) {
                let menuContent = '';

                switch(menuPath) {
                    case 'main':
                        menuContent = `
Arens_v2.0.8/Menu
=============
[1] Ship Modi
[2] Ship Info
[3] Omniweb
[4] Settings
[5] On/Off/Restart
-------------`;
                        break;

                    case 'onoffrestart':
                        menuContent = `
Arens_v2.0.8/On/Off/Restart
==========================
[1] On
[2] Off
[3] Restart
[4] Back
-------------`;
                        break;

                    case 'shipinfo':
                        menuContent = `
Arens_v2.0.8/Ship Info
=====================
${systemState.shipName}
Hull Integrity: ${systemState.hullIntegrity}%
Core Integrity: ${systemState.coreIntegrity}%
Fuel: ${systemState.fuel}%
O₂: ${systemState.oxygen.toString().padStart(2, '0')}%
[1] Refuel Ship
[2] Back
-------------`;
                        break;

                    case 'shipmodi':
                        menuContent = `
Arens_v2.0.8/Ship Modi
=====================
[1] Park
[2] Fly
[3] Combat
[4] Emergency
[5] Back
-------------`;
                        break;

                    case 'shipmodi_fly':
                        const currentConsumption = calculateFuelConsumption(systemState.speed).toFixed(2);
                        menuContent = `
Arens_v2.0.8/Ship Modi/Fly
=========================
Fuel: ${systemState.fuel}%
Fuel consumption: ${currentConsumption}%/ly
Current Speed: ${systemState.speed.toLocaleString()}km/h
Nearest FTL Opportunity: ███████
[1] Speed Increase
[2] Speed Decrease
[3] Manual Steering
[4] Automatic Steering
[5] Back
-------------`;
                        break;

                    case 'omniweb':
                        menuContent = `
Arens_v2.0.8/Omniweb
===================
[1] Galactic News
[2] System Maps
[3] Contact Directory
[4] Mission Logs
[5] Back
-------------`;
                        break;

                    case 'settings':
                        menuContent = `
Arens_v2.0.8/Settings
====================
[1] Display Settings
[2] Audio Settings
[3] Security Settings
[4] Diagnostics
[5] Back
-------------`;
                        break;

                    default:
                        menuContent = `Unknown menu path: ${menuPath}`;
                }

                return menuContent;
            }

            // Function to handle menu selection
            function handleMenuSelection(selection, term) {
                const currentMenu = menuStack[menuStack.length - 1];
                let response = '';

                switch(currentMenu) {
                    case 'main':
                        switch(selection) {
                            case '1':
                                menuStack.push('shipmodi');
                                return displayMenu('shipmodi');
                            case '2':
                                menuStack.push('shipinfo');
                                return displayMenu('shipinfo');
                            case '3':
                                menuStack.push('omniweb');
                                return displayMenu('omniweb');
                            case '4':
                                menuStack.push('settings');
                                return displayMenu('settings');
                            case '5':
                                menuStack.push('onoffrestart');
                                return displayMenu('onoffrestart');
                            default:
                                return `Invalid selection. Please choose 1-5.\n\n${displayMenu('main')}`;
                        }

                    case 'onoffrestart':
                        switch(selection) {
                            case '1':
                                if (systemState.poweredOn) {
                                    response = "System is already powered on.";
                                } else {
                                    systemState.poweredOn = true;
                                    response = "System powered on successfully.";
                                }
                                return response + "\n\n" + displayMenu('onoffrestart');
                            case '2':
                                systemState.poweredOn = false;
                                response = "WARNING: System powering down. All functions will be unavailable.";
                                return response + "\n\n" + displayMenu('onoffrestart');
                            case '3':
                                response = "System restarting...\n[██████████] 100%\nSystem rebooted successfully.";
                                return response + "\n\n" + displayMenu('onoffrestart');
                            case '4':
                                menuStack.pop();
                                return displayMenu('main');
                            default:
                                return `Invalid selection. Please choose 1-4.\n\n${displayMenu('onoffrestart')}`;
                        }

                    case 'shipinfo':
                        if (selection === '1') {
                            if (systemState.fuel >= 100) {
                                response = "Fuel tanks are already at maximum capacity.";
                            } else {
                                const refuelAmount = 100 - systemState.fuel;
                                systemState.fuel = 100;
                                response = `Refueling complete. Added ${refuelAmount}% fuel.\nFuel level now at maximum capacity.`;
                            }
                            return response;
                        } else if (selection === '2') {
                            menuStack.pop();
                            return displayMenu('main');
                        }
                        return `Invalid selection. Please choose 1-2.\n\n${displayMenu('shipinfo')}`;

                    case 'shipmodi':
                        switch(selection) {
                            case '1':
                                systemState.mode = 'Park';
                                systemState.speed = 0;
                                response = "Ship mode set to: Park. All propulsion systems offline.";
                                break;
                            case '2':
                                menuStack.push('shipmodi_fly');
                                return displayMenu('shipmodi_fly');
                            case '3':
                                systemState.mode = 'Combat';
                                response = "WARNING: Combat mode engaged. All weapons systems online. Shields at maximum.";
                                break;
                            case '4':
                                systemState.mode = 'Emergency';
                                response = "EMERGENCY MODE ACTIVATED. Brace for impact. Sending distress signal...";
                                break;
                            case '5':
                                menuStack.pop();
                                return displayMenu('main');
                            default:
                                return `Invalid selection. Please choose 1-5.\n\n${displayMenu('shipmodi')}`;
                        }
                        return response + "\n\n" + displayMenu('shipmodi');

                    case 'shipmodi_fly':
                        switch(selection) {
                            case '1':
                                if (systemState.fuel <= 0) {
                                    response = "WARNING: Insufficient fuel. Cannot increase speed.";
                                } else {
                                    systemState.speed += 10000;
                                    const increaseConsumption = calculateFuelConsumption(systemState.speed);
                                    systemState.fuel = Math.max(0, systemState.fuel - increaseConsumption * 0.1);
                                    response = `Speed increased to: ${systemState.speed.toLocaleString()}km/h\nFuel consumption: ${increaseConsumption.toFixed(2)}%/ly`;
                                }
                                break;
                            case '2':
                                systemState.speed = Math.max(0, systemState.speed - 10000);
                                const decreaseConsumption = calculateFuelConsumption(systemState.speed);
                                response = `Speed decreased to: ${systemState.speed.toLocaleString()}km/h\nFuel consumption: ${decreaseConsumption.toFixed(2)}%/ly`;
                                break;
                            case '3':
                                response = "Manual steering engaged. Use joystick controls. Warning: High-G maneuvers may cause structural stress.";
                                break;
                            case '4':
                                response = "Automatic steering engaged. Course locked to destination. ETA: 3 days 7 hours.";
                                break;
                            case '5':
                                menuStack.pop();
                                return displayMenu('shipmodi');
                            default:
                                return `Invalid selection. Please choose 1-5.\n\n${displayMenu('shipmodi_fly')}`;
                        }
                        return response + "\n\n" + displayMenu('shipmodi_fly');

                    case 'omniweb':
                        switch(selection) {
                            case '1':
                                response = "Galactic News Feed:\n- New trade route discovered in Sector 7\n- Diplomatic tensions rising near Orion Nebula\n- Mining colony established on Kepler-186f\n- Rare mineral deposits found on uninhabited moon";
                                break;
                            case '2':
                                response = "System Maps loading...\n[████████░░] 80%\nMaps available for:\n- Solar System\n- Alpha Centauri\n- Proxima Centauri\n- TRAPPIST-1\n- Vega Colony\n- Kepler Station";
                                break;
                            case '3':
                                response = "Contact Directory:\n- Captain Vance: Ship Command (Ext. 101)\n- Dr. Rostov: Medical Bay (Ext. 205)\n- Chief Engineer Tarek: Engineering (Ext. 301)\n- Lt. Chen: Navigation (Ext. 402)\n- Officer Jax: Security (Ext. 510)";
                                break;
                            case '4':
                                response = `${systemState.missionLogs.join('\n')}`;
                                break;
                            case '5':
                                menuStack.pop();
                                return displayMenu('main');
                            default:
                                return `Invalid selection. Please choose 1-5.\n\n${displayMenu('omniweb')}`;
                        }
                        return response + "\n\n" + displayMenu('omniweb');

                    case 'settings':
                        switch(selection) {
                            case '1':
                                response = "Display Settings:\n- Current Theme: " + systemState.theme.charAt(0).toUpperCase() + systemState.theme.slice(1) + "\n- Brightness: 85%\n- Contrast: 70%\n- Font Size: 12pt\n- Screen Timeout: 5 minutes\n\nAvailable Themes: compcon, crimson, emerald";
                                break;
                            case '2':
                                response = "Audio Settings:\n- Volume: 75%\n- Alert Volume: 100%\n- Voice Commands: Disabled\n- Background Music: Off\n- Warning Tones: Enabled";
                                break;
                            case '3':
                                response = "Security Settings:\n- Login Required: Yes\n- Auto-lock: 5 minutes\n- Encryption: Level 3\n- Access Logs: Enabled\n- Biometric Scan: Active";
                                break;
                            case '4':
                                response = `System Diagnostics:\n- CPU: ${systemState.diagnostics.cpu}\n- Memory: ${systemState.diagnostics.memory}\n- Power Distribution: ${systemState.diagnostics.powerDistribution}\n- Network Latency: ${systemState.diagnostics.networkLatency}\n- Security Level: ${systemState.diagnostics.securityLevel}`;
                                break;
                            case '5':
                                menuStack.pop();
                                return displayMenu('main');
                            default:
                                return `Invalid selection. Please choose 1-5.\n\n${displayMenu('settings')}`;
                        }
                        return response + "\n\n" + displayMenu('settings');
                }
            }

            // Handle theme changes - FIXED VERSION
            function handleThemeChange(themeName) {
                // Remove all theme classes
                $('body').removeClass('theme-compcon theme-crimson theme-emerald');

                // Add new theme class
                $('body').addClass(`theme-${themeName}`);

                // Update system state
                systemState.theme = themeName;

                // Force terminal to refresh colors
                setTimeout(() => {
                    term.echo(`Theme changed to: ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`);
                }, 100);

                return ''; // Don't return anything here, we handle the echo in the timeout
            }

            // Hidden easter egg command - simplified version without box formatting
            function handleFastfetch(term) {
                const now = new Date();
                const timestamp = now.toTimeString().split(' ')[0];

                return `
=== ARENS SYSTEM INFORMATION ===

OS: StarOS v7.3.1
Host: Krokodil-Class Cruiser
Kernel: Quantum-9.4.2
Uptime: 42 days, 7 hours
Shell: Terminal v2.0.8
Resolution: 80x24
WM: HoloGrid Interface
CPU: Fusion Core x4 @ 5.2GHz
Memory: 11.8MB / 16MB
Storage: 120MB SSD
Fuel Level: ${systemState.fuel}%
Current Speed: ${systemState.speed.toLocaleString()} km/h
Mode: ${systemState.mode}
Timestamp: ${timestamp}

[██████████████████████████████] 100%
System Status: OPTIMAL
`.trim();
            }

            // Initialize background logs
            function initBackgroundLogs() {
                const backgroundLeft = $('#background-left');
                const backgroundRight = $('#background-right');

                // Create multiple log entries for each side
                for (let i = 0; i < 15; i++) {
                    const logEntry = backgroundLogs[i % backgroundLogs.length];
                    const logEntry2 = backgroundLogs[(i + 5) % backgroundLogs.length];

                    const logElement = $('<div class="background-log"></div>').text(logEntry);
                    const logElement2 = $('<div class="background-log"></div>').text(logEntry2);

                    // Randomize animation duration and delay
                    const duration = 20 + Math.random() * 30;
                    const delay = Math.random() * 10;

                    logElement.css({
                        'animation-duration': `${duration}s`,
                        'animation-delay': `${delay}s`,
                        'top': `${Math.random() * 100}%`
                    });

                    logElement2.css({
                        'animation-duration': `${duration}s`,
                        'animation-delay': `${delay + 5}s`,
                        'top': `${Math.random() * 100}%`
                    });

                    backgroundLeft.append(logElement);
                    backgroundRight.append(logElement2);
                }
            }

            // Initialize the terminal
            const term = $('#terminal').terminal(function(command) {
                const currentTime = new Date().toLocaleTimeString();
                $('#system-time').text(currentTime);

                if (!systemState.poweredOn && !['power on', 'help', 'clear'].includes(command.toLowerCase())) {
                    this.echo("SYSTEM OFFLINE. Use 'power on' to start the system.");
                    return;
                }

                // Handle hidden easter egg first
                if (command.toLowerCase() === 'fastfetch') {
                    this.echo(handleFastfetch(this));
                    return;
                }

                if (command.toLowerCase() === 'refuel' || command.toLowerCase() === 'refuel ship') {
                    if (systemState.fuel >= 100) {
                        this.echo("Fuel tanks are already at maximum capacity.");
                    } else {
                        const refuelAmount = 100 - systemState.fuel;
                        systemState.fuel = 100;
                        this.echo(`Refueling complete. Added ${refuelAmount}% fuel.\nFuel level now at maximum capacity.`);
                    }
                    // Always show the ship info menu after refueling
                    this.echo("\n" + displayMenu('shipinfo'));
                    return;
                }

                // Handle special commands
                if (command.toLowerCase() === 'help') {
                    this.echo(`
Arens Computer System Help:
- Type menu numbers (1-5) to navigate
- Type text commands like 'back', 'ship info', 'combat mode' etc.
- Type 'refuel' to refuel the ship
- Type 'status' to see system status
- Type 'clear' to clear screen
- Type 'help' to see this help message
- Use mouse wheel to scroll through history
                    `);
                    return;
                }

                if (command.toLowerCase() === 'status') {
                    this.echo(`
System Status:
Ship Name: ${systemState.shipName}
Power: ${systemState.poweredOn ? 'ONLINE' : 'OFFLINE'}
Current Mode: ${systemState.mode}
Hull Integrity: ${systemState.hullIntegrity}%
Core Integrity: ${systemState.coreIntegrity}%
Fuel Level: ${systemState.fuel}%
Oxygen Level: ${systemState.oxygen}%
Current Speed: ${systemState.speed.toLocaleString()} km/h
Fuel Consumption: ${calculateFuelConsumption(systemState.speed).toFixed(2)}%/ly
                    `);
                    return;
                }

                if (command.toLowerCase() === 'diagnostics') {
                    this.echo(`
Running full system diagnostics...
[▒▒▒▒▒▒▒▒▒▒] 0%
`);
                    setTimeout(() => {
                        this.echo("[████▒▒▒▒▒▒] 40%\nChecking power systems...");
                    }, 500);
                    setTimeout(() => {
                        this.echo("[████████▒▒] 80%\nVerifying navigation integrity...");
                    }, 1000);
                    setTimeout(() => {
                        this.echo("[██████████] 100%\nDiagnostics complete.\nAll systems nominal.");
                    }, 1500);
                    return;
                }

                if (command.toLowerCase() === 'crew') {
                    let crewReport = "CREW STATUS REPORT:\n";
                    systemState.crew.forEach(member => {
                        crewReport += `\n- ${member.name}\n  Role: ${member.role}\n  Status: ${member.status}\n  Location: ${['Bridge', 'Medical Bay', 'Engineering', 'Quarters', 'Armory'][Math.floor(Math.random() * 5)]}`;
                    });
                    this.echo(crewReport);
                    return;
                }

                if (command.toLowerCase() === 'alerts') {
                    this.echo("SYSTEM ALERTS:\n" + systemState.systemAlerts.join('\n'));
                    return;
                }

                if (command.toLowerCase() === 'clear') {
                    this.clear();
                    if (menuStack.length > 0) {
                        this.echo(displayMenu(menuStack[menuStack.length - 1]));
                    }
                    return;
                }

                if (command.toLowerCase() === 'main') {
                    menuStack.length = 1;
                    this.echo(displayMenu('main'));
                    return;
                }

                if (command.toLowerCase() === 'back') {
                    if (menuStack.length > 1) {
                        menuStack.pop();
                        this.echo(displayMenu(menuStack[menuStack.length - 1]));
                    } else {
                        this.echo("Already at main menu.");
                    }
                    return;
                }

                // Handle theme commands
                if (command.toLowerCase().startsWith('theme ')) {
                    const themeName = command.toLowerCase().split(' ')[1];
                    const validThemes = ['compcon', 'crimson', 'emerald'];
                    if (validThemes.includes(themeName)) {
                        handleThemeChange(themeName);
                        // Don't return here, the theme change will echo its own message
                        return;
                    } else {
                        this.echo(`Invalid theme. Available themes: ${validThemes.join(', ')}`);
                        return;
                    }
                }

                if (command.toLowerCase() === 'power on') {
                    if (systemState.poweredOn) {
                        this.echo("System is already powered on.");
                        return;
                    }
                    systemState.poweredOn = true;
                    this.echo("Powering on Arens system...");
                    setTimeout(() => {
                        this.echo("[██████████] 100%");
                        this.echo("System initialized successfully.");
                        this.echo(displayMenu('main'));
                    }, 1000);
                    return;
                }

                // Handle command mappings for current menu
                const currentMenu = menuStack[menuStack.length - 1];
                const normalizedCommand = command.toLowerCase().trim();

                // Check if this is a mapped command for the current menu
                if (commandMappings[currentMenu] && commandMappings[currentMenu][normalizedCommand]) {
                    const selection = commandMappings[currentMenu][normalizedCommand];
                    const response = handleMenuSelection(selection, this);
                    this.echo(response);
                    return;
                }

                // Handle numeric menu selections
                const selection = command.trim();
                if (/^[1-9]$/.test(selection)) {
                    const response = handleMenuSelection(selection, this);
                    this.echo(response);
                    return;
                }

                // Handle system alerts randomly
                if (Math.random() > 0.8 && systemState.poweredOn) {
                    const randomAlert = systemState.systemAlerts[Math.floor(Math.random() * systemState.systemAlerts.length)];
                    setTimeout(() => {
                        this.echo(`\nSYSTEM ALERT: ${randomAlert}`);
                    }, 1500);
                }

                this.echo(`Unknown command: "${command}". Type 'help' for available commands.`);
            }, {
                greetings: `
┌─────────────────────────────────────────────┐
│   ARENS COMPUTER SYSTEM v2.0.8              │
│   Lancer RPG Edition · Comp/Con Interface   │
│   Memory check: 4.2MB free                  │
│   System integrity: 100%                    │
│                                             │
│   Type 'help' for command assistance        │
│   New in v2.0.8: Background system logs     │
│   Use mouse wheel to scroll up/down         │
└─────────────────────────────────────────────┘
`,
                name: 'arens_terminal',
                height: '100%',
                width: '100%',
                prompt: function() {
                    const currentPath = menuStack.length > 0 ? menuStack.join('/') : 'main';
                    return `Arens_v2.0.8/${currentPath}> `;
                },
                onInit: function() {
                    this.echo(displayMenu('main'));
                },
                scrollOnEcho: true,
                history: true,
                historySize: 100
            });

            // Background matrix effect
            function initMatrixBackground() {
                const canvas = document.getElementById('background-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                const fontSize = 14;
                const columns = canvas.width / fontSize;
                const drops = [];

                // Initialize drop positions
                for(let i = 0; i < columns; i++) {
                    drops[i] = Math.floor(Math.random() * canvas.height / fontSize);
                }

                // Matrix characters with Lancer-themed symbols
                const matrixChars = "01LANCErRPgMkVSXCTHD+-*/<=>^_█▒░";

                function draw() {
                    // Semi-transparent background for trail effect
                    ctx.fillStyle = "rgba(10, 14, 23, 0.05)";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.fillStyle = "#5c6bc0";
                    ctx.font = fontSize + "px monospace";

                    // Draw characters
                    for(let i = 0; i < drops.length; i++) {
                        // Random character
                        const char = matrixChars.charAt(Math.floor(Math.random() * matrixChars.length));
                        ctx.fillText(char, i * fontSize, drops[i] * fontSize);

                        // Reset drop when it reaches bottom or randomly
                        if(drops[i] * fontSize > canvas.height || Math.random() > 0.975) {
                            drops[i] = 0;
                        }

                        // Move drop down
                        drops[i]++;
                    }
                }

                setInterval(draw, 50);

                // Resize handler
                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                });
            }

            // System time updater
            function updateSystemTime() {
                setInterval(() => {
                    const now = new Date();
                    $('#system-time').text(now.toLocaleTimeString());
                }, 1000);
            }

            // Initialize background and time
            initMatrixBackground();
            initBackgroundLogs();
            updateSystemTime();

            // Add cursor blink effect
            setInterval(() => {
                $('.prompt span:last-child').toggleClass('blink');
            }, 500);
        });
    </script>
</body>
</html>
